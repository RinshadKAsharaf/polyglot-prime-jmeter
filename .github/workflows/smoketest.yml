name: FHIR Bundle SmokeTest
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:  

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'
        cache: maven

    - name: Download and setup JMeter
      run: |
        curl -O https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.6.3.tgz
        tar -xzf apache-jmeter-5.6.3.tgz
        sudo mv apache-jmeter-5.6.3 ./test-automation/

    - name: Decode the .p12 file
      env:
        P12_FILE_BASE64: ${{ secrets.TECHBD_TEMP_HUB_KEY_BASE64 }}
      run: |
          CERT_DIR="./test-automation/Certificates"
          mkdir -p $CERT_DIR
          echo "$P12_FILE_BASE64" | base64 -d > "$CERT_DIR/techbd-temp-HUB-key.p12"

    - name: Set variables
      run: |
        CONFIG_DIR="./test-automation/apache-jmeter-5.6.3/bin"
        CERT_PATH="./test-automation/Certificates/techbd-temp-HUB-key.p12"
        
    - name: Update jmeter.properties
      run: |
          # Update keystore and other ssl properties in jmeter.properties
          sed -i "s|^javax.net.ssl.keyStore=.*|javax.net.ssl.keyStore=$CERT_PATH|" $CONFIG_DIR/jmeter.properties
          sed -i "s|^javax.net.ssl.keyStorePassword=.*|javax.net.ssl.keyStorePassword=|" $CONFIG_DIR/jmeter.properties
          sed -i "s|^javax.net.ssl.keyStoreType=.*|javax.net.ssl.keyStoreType=pkcs12|" $CONFIG_DIR/jmeter.properties

    - name: Update system.properties
      run: |
          # Update keystore and other ssl properties in system.properties
          sed -i "s|^javax.net.ssl.keyStore=.*|javax.net.ssl.keyStore=$CERT_PATH|" $CONFIG_DIR/system.properties
          sed -i "s|^javax.net.ssl.keyStorePassword=.*|javax.net.ssl.keyStorePassword=|" $CONFIG_DIR/system.properties
          sed -i "s|^javax.net.ssl.keyStoreType=.*|javax.net.ssl.keyStoreType=pkcs12|" $CONFIG_DIR/system.properties

    - name: Update user.properties
      run: |
          # Update keystore and other ssl properties in user.properties
          sed -i "s|^javax.net.ssl.keyStore=.*|javax.net.ssl.keyStore=$CERT_PATH|" $CONFIG_DIR/user.properties
          sed -i "s|^javax.net.ssl.keyStorePassword=.*|javax.net.ssl.keyStorePassword=|" $CONFIG_DIR/user.properties
          sed -i "s|^javax.net.ssl.keyStoreType=.*|javax.net.ssl.keyStoreType=pkcs12|" $CONFIG_DIR/user.properties

    - name: Verify updates
      run: |
          echo "Verifying jmeter.properties:"
          cat $CONFIG_DIR/jmeter.properties
          
          echo "Verifying system.properties:"
          cat $CONFIG_DIR/system.properties
          
          echo "Verifying user.properties:"
          cat $CONFIG_DIR/user.properties
        
    - name: Run FHIR Bundle SmokeTest - Devl
      run: |
       mkdir -p ./test-automation/JmeterDevlReport/bundletest
       ./test-automation/apache-jmeter-5.6.3/bin/jmeter -n -t "./test-automation/FHIR-Bundle-SmokeTest-Devl/Bundle.jmx" -l "./test-automation/JmeterDevlResult/bundletest2.jtl"
       ./test-automation/apache-jmeter-5.6.3/bin/jmeter -g "./test-automation/JmeterDevlResult/bundletest2.jtl" -o "./test-automation/JmeterDevlReport/"

    - name: Run FHIR Bundle SmokeTest - Stage
      run: |
        mkdir -p ./test-automation/JmeterStageReport/bundletest
        ./test-automation/apache-jmeter-5.6.3/bin/jmeter -n -t "./test-automation/FHIR-Bundle-SmokeTest-Stage/Bundle.jmx" -l "./test-automation/JmeterStageResult/bundletest.jtl"
        ./test-automation/apache-jmeter-5.6.3/bin/jmeter -g "./test-automation/JmeterStageResult/bundletest.jtl" -o "./test-automation/JmeterStageReport/"

    - name: Run FHIR Bundle SmokeTest - QA
      run: |
        /home/ubuntu/apache-jmeter-5.6.3/bin/jmeter -n -t "/home/ubuntu/apache-jmeter-5.6.3/FHIR-Bundle-SmokeTest-PHI-QA/Bundle.jmx" -l "/home/ubuntu/JmeterPHIQAResult/bundletest.jtl"
        /home/ubuntu/apache-jmeter-5.6.3/bin/jmeter -g "/home/ubuntu/JmeterPHIQAResult/bundletest.jtl" -o "/home/ubuntu/JmeterPHIQAReport/"

    - name: Archive JMeter Reports into ZIP files
      run: |
        sudo apt-get install -y zip
        cd ./test-automation
        zip -r ./JmeterDevlReport.zip ./JmeterDevlReport/
        zip -r ./JmeterStageReport.zip ./JmeterStageReport/
        zip -r ./JmeterPHIQAReport.zip /home/ubuntu/JmeterPHIQAReport/bundletest

    - name: Send email with JMeter reports
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: email-smtp.us-east-1.amazonaws.com
        server_port: 587
        username: ${{ secrets.SES_SMTP_USERNAME }}
        password: ${{ secrets.SES_SMTP_PASSWORD }}
        subject: "TechBD FHIR Bundle SmokeTest"
        body: |
            Hello Team,
            
            This is an automated notification for the FHIR Bundle SmokeTest results generated every hour.  

            Test Summary (Hourly Run):
            - Development Report: Attached
            - Stage Report: Attached
            - QA Report: Attached

            Please find the attached reports for detailed results of the tests executed during the last hour.

            Regards,  
            Tech by Design Automation Team  

        content_type: "text/plain"
        from: "Tech by Design FHIR SmokeTest Result <no-reply@tx.techbd.org>"
        to: nidhin-unni@netspective.in, rinshad-asharaf@netspective.in
        attachments: |
          ./JmeterDevlReport.zip        
          ./JmeterStageReport.zip
          ./JmeterPHIQAReport.zip
